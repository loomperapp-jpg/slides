<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GUIA_TECNICO_DESENVOLVEDOR_LOOMPER.md</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="🔧-loomper---guia-técnico-do-desenvolvedor">🔧 LOOMPER - GUIA TÉCNICO DO DESENVOLVEDOR</h1>
<h2 id="📋-índice-técnico">📋 ÍNDICE TÉCNICO</h2>
<ol>
<li><a href="#1-arquitetura-de-sistema">Arquitetura de Sistema</a></li>
<li><a href="#2-estrutura-de-dados-firestore">Estrutura de Dados Firestore</a></li>
<li><a href="#3-fluxogramas-de-processos">Fluxogramas de Processos</a></li>
<li><a href="#4-exemplos-de-c%C3%B3digo">Exemplos de Código</a></li>
<li><a href="#5-apis-e-integra%C3%A7%C3%B5es">APIs e Integrações</a></li>
<li><a href="#6-troubleshooting">Troubleshooting</a></li>
</ol>
<hr>
<h2 id="arquitetura-de-sistema">1. ARQUITETURA DE SISTEMA</h2>
<h3 id="diagrama-de-arquitetura">1.1 Diagrama de Arquitetura</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    LOOMPER PLATFORM                          │
│                                                              │
│  ┌──────────────┐      ┌──────────────┐      ┌───────────┐ │
│  │  Flutter App │◄────►│   Firebase   │◄────►│ External  │ │
│  │  (Android)   │      │   Services   │      │  APIs     │ │
│  └──────────────┘      └──────────────┘      └───────────┘ │
│                                                              │
│  Components:              Services:           Integrations:  │
│  - Auth Screens          - Firestore         - WhatsApp API │
│  - Demand Screens        - Auth             - IBGE API      │
│  - Profile Screens       - Storage          - Google Maps   │
│  - Application Screens   - FCM              - Payment GW    │
│                          - Analytics                         │
└─────────────────────────────────────────────────────────────┘

State Management: Provider Pattern
Navigation: Named Routes
Local Storage: Hive + SharedPreferences
</code></pre>
<h3 id="camadas-da-aplicação">1.2 Camadas da Aplicação</h3>
<pre><code>┌─────────────────────────────────────────┐
│        PRESENTATION LAYER                │
│  ┌─────────────────────────────────┐   │
│  │  Screens (UI)                    │   │
│  │  - LoginScreen                   │   │
│  │  - DemandListScreen             │   │
│  │  - CreateDemandScreen           │   │
│  └─────────────────────────────────┘   │
│             ▲                            │
│             │ Consumes                  │
│             ▼                            │
│  ┌─────────────────────────────────┐   │
│  │  Providers (State Management)   │   │
│  │  - AuthProvider                 │   │
│  │  - DemandProvider              │   │
│  │  - CreditsProvider             │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
                  │
                  │ Uses
                  ▼
┌─────────────────────────────────────────┐
│           BUSINESS LOGIC LAYER           │
│  ┌─────────────────────────────────┐   │
│  │  Services                        │   │
│  │  - AuthService                  │   │
│  │  - DemandService               │   │
│  │  - CreditsService              │   │
│  │  - WhatsAppService             │   │
│  │  - GamificationService         │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
                  │
                  │ Persists
                  ▼
┌─────────────────────────────────────────┐
│            DATA LAYER                    │
│  ┌─────────────────────────────────┐   │
│  │  Models                          │   │
│  │  - UserModel                    │   │
│  │  - DemandModel                 │   │
│  │  - ApplicationModel            │   │
│  └─────────────────────────────────┘   │
│                                          │
│  ┌─────────────────────────────────┐   │
│  │  Firebase Firestore              │   │
│  │  - users/                        │   │
│  │  - demands/                      │   │
│  │  - applications/                 │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
</code></pre>
<hr>
<h2 id="estrutura-de-dados-firestore">2. ESTRUTURA DE DADOS FIRESTORE</h2>
<h3 id="collection-users">2.1 Collection: users/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"user_id_123"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"uid"</span><span class="token punctuation">:</span> <span class="token string">"user_id_123"</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"João Silva"</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"joao@example.com"</span><span class="token punctuation">,</span>
    <span class="token string">"phone"</span><span class="token punctuation">:</span> <span class="token string">"+5511987654321"</span><span class="token punctuation">,</span>
    <span class="token string">"whatsapp_number"</span><span class="token punctuation">:</span> <span class="token string">"+5511987654321"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Perfil</span>
    <span class="token string">"profile"</span><span class="token punctuation">:</span> <span class="token string">"motorista"</span><span class="token punctuation">,</span>  <span class="token comment">// chapa | motorista | transportadora</span>
    <span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"São Paulo"</span><span class="token punctuation">,</span>
    <span class="token string">"state"</span><span class="token punctuation">:</span> <span class="token string">"SP"</span><span class="token punctuation">,</span>
    <span class="token string">"photo_url"</span><span class="token punctuation">:</span> <span class="token string">"https://storage.googleapis.com/..."</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Reputação</span>
    <span class="token string">"reputation"</span><span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>
    <span class="token string">"total_ratings"</span><span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
    <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Favoritos (para motoristas)</span>
    <span class="token string">"favorites"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"chapa_id_1"</span><span class="token punctuation">,</span> <span class="token string">"chapa_id_2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    
    <span class="token comment">// FCM</span>
    <span class="token string">"fcm_tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"fcm_token_android_1"</span><span class="token punctuation">,</span> <span class="token string">"fcm_token_web_1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Disponibilidade (para chapas)</span>
    <span class="token string">"work_radius"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  <span class="token comment">// km</span>
    <span class="token string">"is_available"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"last_availability_change"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-20T10:30:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Gamificação</span>
    <span class="token string">"last_access"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T08:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"streak"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token string">"best_streak"</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Termos e criação</span>
    <span class="token string">"terms_accepted"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"terms_accepted_at"</span><span class="token punctuation">:</span> <span class="token string">"2025-12-01T10:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2025-12-01T10:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T08:00:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// ────────────────────────────────────────</span>
    <span class="token comment">// SUBCOLLECTIONS</span>
    <span class="token comment">// ────────────────────────────────────────</span>
    
    <span class="token string">"/wallets/wallet_id_1"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"user_id_123"</span><span class="token punctuation">,</span>
      <span class="token string">"balance"</span><span class="token punctuation">:</span> <span class="token number">850</span><span class="token punctuation">,</span>              <span class="token comment">// Saldo disponível</span>
      <span class="token string">"reserved_balance"</span><span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span>     <span class="token comment">// Créditos reservados</span>
      <span class="token string">"total_earned"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>        <span class="token comment">// Total ganho (histórico)</span>
      <span class="token string">"total_spent"</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>         <span class="token comment">// Total gasto (histórico)</span>
      <span class="token string">"last_renewal_date"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-01T00:00:00Z"</span><span class="token punctuation">,</span>
      <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2025-12-01T10:00:00Z"</span><span class="token punctuation">,</span>
      <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T08:00:00Z"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token string">"/credit_transactions/transaction_id_1"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"user_id_123"</span><span class="token punctuation">,</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"addition"</span><span class="token punctuation">,</span>  <span class="token comment">// addition | deduction</span>
      <span class="token string">"amount"</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token string">"balance_before"</span><span class="token punctuation">:</span> <span class="token number">850</span><span class="token punctuation">,</span>
      <span class="token string">"balance_after"</span><span class="token punctuation">:</span> <span class="token number">1850</span><span class="token punctuation">,</span>
      <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"💰 Renovação mensal"</span><span class="token punctuation">,</span>
      <span class="token string">"related_id"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-01T00:00:00Z"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token string">"/credit_transactions/transaction_id_2"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"user_id_123"</span><span class="token punctuation">,</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"deduction"</span><span class="token punctuation">,</span>
      <span class="token string">"amount"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span>
      <span class="token string">"balance_before"</span><span class="token punctuation">:</span> <span class="token number">1850</span><span class="token punctuation">,</span>
      <span class="token string">"balance_after"</span><span class="token punctuation">:</span> <span class="token number">1800</span><span class="token punctuation">,</span>
      <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"📝 Demanda criada: Carga em SP"</span><span class="token punctuation">,</span>
      <span class="token string">"related_id"</span><span class="token punctuation">:</span> <span class="token string">"demand_id_456"</span><span class="token punctuation">,</span>
      <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-03T14:30:00Z"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token string">"/achievements/achievement_id_1"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"achievement_id"</span><span class="token punctuation">:</span> <span class="token string">"first_demand"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Primeira Demanda"</span><span class="token punctuation">,</span>
      <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Crie sua primeira demanda"</span><span class="token punctuation">,</span>
      <span class="token string">"icon"</span><span class="token punctuation">:</span> <span class="token string">"📝"</span><span class="token punctuation">,</span>
      <span class="token string">"bonus"</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token string">"unlocked_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-03T14:30:00Z"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="collection-demands">2.2 Collection: demands/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"demand_id_456"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"demand_id_456"</span><span class="token punctuation">,</span>
    <span class="token string">"created_by"</span><span class="token punctuation">:</span> <span class="token string">"motorista_user_id_123"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Detalhes da demanda</span>
    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Carga e descarga em São Paulo"</span><span class="token punctuation">,</span>
    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Preciso de ajuda com carga de 15 veículos no terminal ABC"</span><span class="token punctuation">,</span>
    <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"Terminal ABC, Zona Leste, São Paulo - SP"</span><span class="token punctuation">,</span>
    <span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"São Paulo"</span><span class="token punctuation">,</span>
    <span class="token string">"state"</span><span class="token punctuation">:</span> <span class="token string">"SP"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Agendamento</span>
    <span class="token string">"scheduled_date"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T00:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"scheduled_time"</span><span class="token punctuation">:</span> <span class="token string">"08:00"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Tipo e valor</span>
    <span class="token string">"support_type"</span><span class="token punctuation">:</span> <span class="token string">"cargaDescarga"</span><span class="token punctuation">,</span>  <span class="token comment">// guia | carga | descarga | cargaDescarga | manobra | conferencia</span>
    <span class="token string">"offered_value"</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>  <span class="token comment">// Créditos que o chapa vai receber</span>
    
    <span class="token comment">// Status e fluxo</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"matched"</span><span class="token punctuation">,</span>  <span class="token comment">// open | pendingSelection | matched | inProgress | completed | cancelled</span>
    
    <span class="token comment">// Favoritos convidados</span>
    <span class="token string">"invited_favorites"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"chapa_id_1"</span><span class="token punctuation">,</span> <span class="token string">"chapa_id_2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Match (quando aceito)</span>
    <span class="token string">"selected_chapa_id"</span><span class="token punctuation">:</span> <span class="token string">"chapa_id_789"</span><span class="token punctuation">,</span>
    <span class="token string">"service_code"</span><span class="token punctuation">:</span> <span class="token string">"4728-9135"</span><span class="token punctuation">,</span>  <span class="token comment">// MMMM-CCCC</span>
    <span class="token string">"motorista_code"</span><span class="token punctuation">:</span> <span class="token string">"4728"</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_code"</span><span class="token punctuation">:</span> <span class="token string">"9135"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Pagamento</span>
    <span class="token string">"reserved_amount"</span><span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span>  <span class="token comment">// Créditos reservados do motorista</span>
    <span class="token string">"transaction_id"</span><span class="token punctuation">:</span> <span class="token string">"transaction_id_3"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Auditoria</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-03T14:30:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T09:00:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="collection-applications">2.3 Collection: applications/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"application_id_789"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"application_id_789"</span><span class="token punctuation">,</span>
    <span class="token string">"demand_id"</span><span class="token punctuation">:</span> <span class="token string">"demand_id_456"</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_id"</span><span class="token punctuation">:</span> <span class="token string">"chapa_user_id_789"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Dados do chapa (denormalizados para performance)</span>
    <span class="token string">"chapa_name"</span><span class="token punctuation">:</span> <span class="token string">"Carlos Souza"</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_photo"</span><span class="token punctuation">:</span> <span class="token string">"https://storage.googleapis.com/..."</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_reputation"</span><span class="token punctuation">:</span> <span class="token number">4.8</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_total_ratings"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Status</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"accepted"</span><span class="token punctuation">,</span>  <span class="token comment">// pending | accepted | rejected | expired</span>
    
    <span class="token comment">// Datas</span>
    <span class="token string">"applied_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-03T15:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T09:00:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="collection-services">2.4 Collection: services/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"service_id_101"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"service_id_101"</span><span class="token punctuation">,</span>
    <span class="token string">"demand_id"</span><span class="token punctuation">:</span> <span class="token string">"demand_id_456"</span><span class="token punctuation">,</span>
    <span class="token string">"motorista_id"</span><span class="token punctuation">:</span> <span class="token string">"motorista_user_id_123"</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_id"</span><span class="token punctuation">:</span> <span class="token string">"chapa_user_id_789"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Código de serviço</span>
    <span class="token string">"service_code"</span><span class="token punctuation">:</span> <span class="token string">"4728-9135"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Status</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"completed"</span><span class="token punctuation">,</span>  <span class="token comment">// scheduled | inProgress | completed | cancelled | noShow</span>
    
    <span class="token comment">// Agendamento e execução</span>
    <span class="token string">"scheduled_date"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T00:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"scheduled_time"</span><span class="token punctuation">:</span> <span class="token string">"08:00"</span><span class="token punctuation">,</span>
    <span class="token string">"started_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T08:15:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"completed_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T12:30:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Avaliação do motorista sobre o chapa</span>
    <span class="token string">"motorista_rating"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"motorista_review"</span><span class="token punctuation">:</span> <span class="token string">"Excelente profissional! Muito ágil e cuidadoso."</span><span class="token punctuation">,</span>
    <span class="token string">"motorista_reviewed_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T12:35:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Avaliação do chapa sobre o motorista</span>
    <span class="token string">"chapa_rating"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_review"</span><span class="token punctuation">:</span> <span class="token string">"Motorista educado e organizado. Recomendo!"</span><span class="token punctuation">,</span>
    <span class="token string">"chapa_reviewed_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T12:40:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Auditoria</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-22T09:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T12:40:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="collection-referrals">2.5 Collection: referrals/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"referral_id_202"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"referral_id"</span><span class="token punctuation">:</span> <span class="token string">"referral_id_202"</span><span class="token punctuation">,</span>
    <span class="token string">"referrer_id"</span><span class="token punctuation">:</span> <span class="token string">"user_id_123"</span><span class="token punctuation">,</span>  <span class="token comment">// Quem indicou</span>
    <span class="token string">"referred_id"</span><span class="token punctuation">:</span> <span class="token string">"user_id_456"</span><span class="token punctuation">,</span>  <span class="token comment">// Quem foi indicado</span>
    <span class="token string">"referred_name"</span><span class="token punctuation">:</span> <span class="token string">"Pedro Santos"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Status e nível</span>
    <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"active"</span><span class="token punctuation">,</span>  <span class="token comment">// invited | registered | active | active_level_2</span>
    <span class="token string">"level"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// 1 = direto, 2 = indireto (MLM)</span>
    
    <span class="token comment">// Bônus concedidos</span>
    <span class="token string">"bonuses_earned"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"invited"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment">// +50 créditos</span>
      <span class="token string">"registered"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// +100 créditos</span>
      <span class="token string">"used_app"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token comment">// +150 créditos</span>
      <span class="token string">"level_2"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>      <span class="token comment">// +200 créditos (se indicou outro)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Datas dos bônus</span>
    <span class="token string">"invited_bonus_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-20T10:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"registered_bonus_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-20T10:30:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"used_app_bonus_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-21T14:00:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Ativação</span>
    <span class="token string">"activated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-21T14:00:00Z"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Auditoria</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-20T10:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-21T14:00:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="collection-cancellations">2.6 Collection: cancellations/</h3>
<pre class=" language-javascript"><code class="prism  language-javascript"><span class="token punctuation">{</span>
  <span class="token string">"cancellation_id_303"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identificação</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"cancellation_id_303"</span><span class="token punctuation">,</span>
    <span class="token string">"demand_id"</span><span class="token punctuation">:</span> <span class="token string">"demand_id_456"</span><span class="token punctuation">,</span>
    <span class="token string">"application_id"</span><span class="token punctuation">:</span> <span class="token string">"application_id_789"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Quem cancelou</span>
    <span class="token string">"cancelled_by"</span><span class="token punctuation">:</span> <span class="token string">"motorista_user_id_123"</span><span class="token punctuation">,</span>
    <span class="token string">"cancelled_role"</span><span class="token punctuation">:</span> <span class="token string">"motorista"</span><span class="token punctuation">,</span>  <span class="token comment">// motorista | chapa</span>
    
    <span class="token comment">// Motivo</span>
    <span class="token string">"reason"</span><span class="token punctuation">:</span> <span class="token string">"mudanca_planos"</span><span class="token punctuation">,</span>  <span class="token comment">// forca_maior | chapa_nao_apareceu | mudanca_planos | outro_chapa | outros</span>
    <span class="token string">"detailed_reason"</span><span class="token punctuation">:</span> <span class="token string">"Viagem foi cancelada pela transportadora"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Datas</span>
    <span class="token string">"cancellation_date"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-24T10:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"scheduled_date"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-25T08:00:00Z"</span><span class="token punctuation">,</span>
    <span class="token string">"hours_before_service"</span><span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Reembolso e taxa</span>
    <span class="token string">"refund_amount"</span><span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">,</span>  <span class="token comment">// Créditos devolvidos (taxa 20%)</span>
    <span class="token string">"tax_rate"</span><span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token string">"tax_description"</span><span class="token punctuation">:</span> <span class="token string">"⏰ Cancelamento com +24h: Taxa 20%"</span><span class="token punctuation">,</span>
    
    <span class="token comment">// Histórico</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2026-01-24T10:00:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="fluxogramas-de-processos">3. FLUXOGRAMAS DE PROCESSOS</h2>
<h3 id="fluxo-criação-de-demanda">3.1 Fluxo: Criação de Demanda</h3>
<pre><code>[Motorista] → [Tela: Criar Demanda]
                      ↓
              [Preencher Formulário]
              - Título
              - Descrição
              - Local
              - Data/Hora
              - Tipo de apoio
              - Valor oferecido (créditos)
              - Convidar favoritos (opcional)
                      ↓
              [Validar Créditos]
              Saldo &gt;= 50 créditos?
                      ↓
                   ┌──NO──► [Erro: Saldo insuficiente]
                   │
                  YES
                   │
                   ↓
              [Debitar 50 créditos]
                   ↓
              [Criar documento em demands/]
              status: open
                   ↓
              [Enviar notificação push]
              Para chapas na região (raio)
                   ↓
              [Enviar WhatsApp]
              Para chapas favoritos convidados
                   ↓
              [Demanda criada com sucesso]
</code></pre>
<h3 id="fluxo-candidatura-e-match">3.2 Fluxo: Candidatura e Match</h3>
<pre><code>[Chapa] → [Ver Demanda]
               ↓
        [Candidatar-se]
               ↓
        [Criar application/]
        status: pending
               ↓
        [Notificar Motorista]
        WhatsApp + Push
               ↓
[Motorista] → [Ver Candidatos]
               ↓
        [Selecionar Chapa]
               ↓
        [Validar Créditos]
        Saldo &gt;= 150?
               ↓
            ┌──NO──► [Erro: Saldo insuficiente]
            │
           YES
            │
            ↓
        [Reservar 150 créditos]
        (não debita ainda)
            ↓
        [Atualizar demand/]
        status: matched
        selected_chapa_id: ...
            ↓
        [Gerar Códigos]
        MMMM-CCCC
        motorista_code: MMMM
        chapa_code: CCCC
            ↓
        [Atualizar application/]
        status: accepted
            ↓
        [Rejeitar Outros Candidatos]
        applications → status: rejected
            ↓
        [Enviar WhatsApp]
        Motorista: código MMMM
        Chapa: código CCCC + detalhes
            ↓
        [Match confirmado]
</code></pre>
<h3 id="fluxo-início-e-conclusão-do-serviço">3.3 Fluxo: Início e Conclusão do Serviço</h3>
<pre><code>[Dia do Serviço]
       ↓
[Motorista] → [Validar Código do Chapa]
Input: CCCC (4 dígitos)
       ↓
[Verificar Código]
Input == chapa_code?
       ↓
    ┌──NO──► [Erro: Código inválido]
    │
   YES
    │
    ↓
[Atualizar demand/]
status: inProgress
started_at: timestamp
    ↓
[Notificar Ambos]
"Serviço iniciado!"
    ↓
[Executar Serviço]
...
    ↓
[Motorista] → [Finalizar Serviço]
    ↓
[Atualizar service/]
status: completed
completed_at: timestamp
    ↓
[Liberar Pagamento]
- Debitar 150 créditos reservados (motorista)
- Creditar 500 créditos (chapa)
    ↓
[Solicitar Avaliação]
Motorista → Avaliar Chapa
Chapa → Avaliar Motorista
    ↓
[Atualizar Reputação]
Recalcular média de avaliações
    ↓
[Desbloquear Conquistas]
Verificar marcos (primeira avaliação 5 estrelas, etc)
    ↓
[Serviço concluído]
</code></pre>
<h3 id="fluxo-cancelamento-com-reembolso">3.4 Fluxo: Cancelamento com Reembolso</h3>
<pre><code>[Motorista] → [Cancelar Match]
                  ↓
          [Selecionar Motivo]
          - Força maior
          - Mudança de planos
          - Chapa não apareceu
          - Outro chapa
          - Outros
                  ↓
          [Calcular Tempo até Serviço]
          hours_until = scheduled_date - now
                  ↓
          [Aplicar Tabela de Reembolso]
          
          SE motivo == "forca_maior":
              reembolso = 150 (taxa 0%)
              
          SE motivo == "outro_chapa":
              reembolso = 0 (taxa 100%)
              
          SENÃO:
              SE hours_until &gt; 24h:
                  reembolso = 120 (taxa 20%)
              SE 12h &lt; hours_until &lt;= 24h:
                  reembolso = 75 (taxa 50%)
              SE hours_until &lt;= 12h:
                  reembolso = 0 (taxa 100%)
                  ↓
          [Liberar Créditos Reservados]
          Adicionar reembolso à carteira
                  ↓
          [Atualizar demand/]
          status: open (volta para disponível)
                  ↓
          [Atualizar application/]
          status: rejected
                  ↓
          [Registrar em cancellations/]
          Salvar histórico completo
                  ↓
          [Notificar Chapa]
          WhatsApp: cancelamento
                  ↓
          [Cancelamento concluído]
</code></pre>
<hr>
<h2 id="exemplos-de-código">4. EXEMPLOS DE CÓDIGO</h2>
<h3 id="criar-demanda">4.1 Criar Demanda</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/presentation/screens/demands/create_demand_screen.dart</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">_createDemand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Validar saldo de créditos</span>
    <span class="token keyword">final</span> creditsService <span class="token operator">=</span> <span class="token function">CreditsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> wallet <span class="token operator">=</span> <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">getWallet</span><span class="token punctuation">(</span>currentUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wallet<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> CreditsService<span class="token punctuation">.</span>demandCreationCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">InsufficientCreditsException</span><span class="token punctuation">(</span>
        <span class="token string">'Saldo insuficiente. Você precisa de ${CreditsService.demandCreationCost} créditos.'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 2. Criar demanda</span>
    <span class="token keyword">final</span> demandService <span class="token operator">=</span> <span class="token function">DemandService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> demandId <span class="token operator">=</span> <span class="token keyword">await</span> demandService<span class="token punctuation">.</span><span class="token function">createDemand</span><span class="token punctuation">(</span>
      createdBy<span class="token punctuation">:</span> currentUserId<span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> _titleController<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
      description<span class="token punctuation">:</span> _descriptionController<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> _locationController<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
      city<span class="token punctuation">:</span> _selectedCity<span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> _selectedState<span class="token punctuation">,</span>
      scheduledDate<span class="token punctuation">:</span> _selectedDate<span class="token punctuation">,</span>
      scheduledTime<span class="token punctuation">:</span> _selectedTime<span class="token punctuation">,</span>
      supportType<span class="token punctuation">:</span> _selectedSupportType<span class="token punctuation">,</span>
      offeredValue<span class="token punctuation">:</span> _offeredValue<span class="token punctuation">,</span>
      invitedFavorites<span class="token punctuation">:</span> _selectedFavorites<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. Debitar créditos</span>
    <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">deductCredits</span><span class="token punctuation">(</span>
      currentUserId<span class="token punctuation">,</span>
      CreditsService<span class="token punctuation">.</span>demandCreationCost<span class="token punctuation">,</span>
      <span class="token string">'📝 Demanda criada: ${_titleController.text}'</span><span class="token punctuation">,</span>
      relatedId<span class="token punctuation">:</span> demandId<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 4. Verificar conquistas</span>
    <span class="token keyword">final</span> gamificationService <span class="token operator">=</span> <span class="token function">GamificationService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> gamificationService<span class="token punctuation">.</span><span class="token function">checkFirstTimeAchievements</span><span class="token punctuation">(</span>
      currentUserId<span class="token punctuation">,</span>
      <span class="token string">'first_demand'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 5. Sucesso</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounted<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    ScaffoldMessenger<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">showSnackBar</span><span class="token punctuation">(</span>
      <span class="token function">SnackBar</span><span class="token punctuation">(</span>content<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'✅ Demanda criada com sucesso!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    Navigator<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> on InsufficientCreditsException <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ScaffoldMessenger<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">showSnackBar</span><span class="token punctuation">(</span>
      <span class="token function">SnackBar</span><span class="token punctuation">(</span>
        content<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
        backgroundColor<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>red<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao criar demanda: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ScaffoldMessenger<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">showSnackBar</span><span class="token punctuation">(</span>
      <span class="token function">SnackBar</span><span class="token punctuation">(</span>content<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'Erro ao criar demanda. Tente novamente.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="aceitar-chapa-match">4.2 Aceitar Chapa (Match)</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/data/services/demand_service.dart</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">acceptChapa</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  required String demandId<span class="token punctuation">,</span>
  required String applicationId<span class="token punctuation">,</span>
  required String chapaId<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Buscar dados da demanda</span>
    <span class="token keyword">final</span> demandDoc <span class="token operator">=</span> <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'demands'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>demandId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> demandData <span class="token operator">=</span> demandDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> motoristaId <span class="token operator">=</span> demandData<span class="token punctuation">[</span><span class="token string">'created_by'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. Validar créditos do motorista</span>
    <span class="token keyword">final</span> creditsService <span class="token operator">=</span> <span class="token function">CreditsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> wallet <span class="token operator">=</span> <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">getWallet</span><span class="token punctuation">(</span>motoristaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wallet<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> CreditsService<span class="token punctuation">.</span>matchAcceptedCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">InsufficientCreditsException</span><span class="token punctuation">(</span>
        <span class="token string">'Saldo insuficiente para aceitar este chapa.'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 3. Reservar créditos (não debita ainda)</span>
    <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">reserveCredits</span><span class="token punctuation">(</span>
      motoristaId<span class="token punctuation">,</span>
      CreditsService<span class="token punctuation">.</span>matchAcceptedCost<span class="token punctuation">,</span>
      <span class="token string">'Reservado para match: $demandId'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 4. Gerar códigos de serviço</span>
    <span class="token keyword">final</span> motoristaCode <span class="token operator">=</span> <span class="token function">_generateCode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MMMM</span>
    <span class="token keyword">final</span> chapaCode <span class="token operator">=</span> <span class="token function">_generateCode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// CCCC</span>
    <span class="token keyword">final</span> serviceCode <span class="token operator">=</span> <span class="token string">'$motoristaCode-$chapaCode'</span><span class="token punctuation">;</span> <span class="token comment">// MMMM-CCCC</span>
    
    <span class="token comment">// 5. Atualizar demanda</span>
    <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'demands'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>demandId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> DemandStatus<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'selected_chapa_id'</span><span class="token punctuation">:</span> chapaId<span class="token punctuation">,</span>
      <span class="token string">'service_code'</span><span class="token punctuation">:</span> serviceCode<span class="token punctuation">,</span>
      <span class="token string">'motorista_code'</span><span class="token punctuation">:</span> motoristaCode<span class="token punctuation">,</span>
      <span class="token string">'chapa_code'</span><span class="token punctuation">:</span> chapaCode<span class="token punctuation">,</span>
      <span class="token string">'reserved_amount'</span><span class="token punctuation">:</span> CreditsService<span class="token punctuation">.</span>matchAcceptedCost<span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 6. Atualizar candidatura aceita</span>
    <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'applications'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> ApplicationStatus<span class="token punctuation">.</span>accepted<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 7. Rejeitar outros candidatos</span>
    <span class="token keyword">final</span> otherApplications <span class="token operator">=</span> <span class="token keyword">await</span> _firestore
        <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'applications'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'demand_id'</span><span class="token punctuation">,</span> isEqualTo<span class="token punctuation">:</span> demandId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> isNotEqualTo<span class="token punctuation">:</span> applicationId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> doc <span class="token keyword">in</span> otherApplications<span class="token punctuation">.</span>docs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> doc<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'status'</span><span class="token punctuation">:</span> ApplicationStatus<span class="token punctuation">.</span>rejected<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 8. Enviar notificações WhatsApp</span>
    <span class="token keyword">final</span> whatsappService <span class="token operator">=</span> <span class="token function">WhatsAppService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Para o chapa</span>
    <span class="token keyword">await</span> whatsappService<span class="token punctuation">.</span><span class="token function">notifyMatchConfirmed</span><span class="token punctuation">(</span>
      chapaPhone<span class="token punctuation">:</span> chapaPhone<span class="token punctuation">,</span>
      demandTitle<span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      serviceCode<span class="token punctuation">:</span> chapaCode<span class="token punctuation">,</span>
      scheduledDate<span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'scheduled_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      scheduledTime<span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'scheduled_time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      offeredValue<span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'offered_value'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Para o motorista</span>
    <span class="token keyword">await</span> whatsappService<span class="token punctuation">.</span><span class="token function">notifyMotoristaCode</span><span class="token punctuation">(</span>
      motoristaPhone<span class="token punctuation">:</span> motoristaPhone<span class="token punctuation">,</span>
      motoristaCode<span class="token punctuation">:</span> motoristaCode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 9. Verificar conquistas</span>
    <span class="token keyword">final</span> gamificationService <span class="token operator">=</span> <span class="token function">GamificationService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> gamificationService<span class="token punctuation">.</span><span class="token function">checkFirstTimeAchievements</span><span class="token punctuation">(</span>
      motoristaId<span class="token punctuation">,</span>
      <span class="token string">'first_match'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'✅ Match confirmado: $serviceCode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao aceitar chapa: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">rethrow</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Gerador de código aleatório</span>
String <span class="token function">_generateCode</span><span class="token punctuation">(</span>int length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> random <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">secure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> List<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="validar-código-e-iniciar-serviço">4.3 Validar Código e Iniciar Serviço</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/data/services/service_service.dart</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">validateChapaCodeAndStartService</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  required String serviceCode<span class="token punctuation">,</span>
  required String inputChapaCode<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Buscar demanda pelo código completo</span>
    <span class="token keyword">final</span> demandQuery <span class="token operator">=</span> <span class="token keyword">await</span> _firestore
        <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'demands'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'service_code'</span><span class="token punctuation">,</span> isEqualTo<span class="token punctuation">:</span> serviceCode<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span>demandQuery<span class="token punctuation">.</span>docs<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">ServiceNotFoundException</span><span class="token punctuation">(</span><span class="token string">'Serviço não encontrado.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">final</span> demandDoc <span class="token operator">=</span> demandQuery<span class="token punctuation">.</span>docs<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword">final</span> demandData <span class="token operator">=</span> demandDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> storedChapaCode <span class="token operator">=</span> demandData<span class="token punctuation">[</span><span class="token string">'chapa_code'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. Validar código do chapa</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputChapaCode <span class="token operator">!=</span> storedChapaCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">InvalidCodeException</span><span class="token punctuation">(</span><span class="token string">'Código inválido. Verifique e tente novamente.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 3. Validar horário (permitir 30min antes do agendado)</span>
    <span class="token keyword">final</span> scheduledDate <span class="token operator">=</span> <span class="token punctuation">(</span>demandData<span class="token punctuation">[</span><span class="token string">'scheduled_date'</span><span class="token punctuation">]</span> <span class="token operator">as</span> Timestamp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> scheduledTime <span class="token operator">=</span> demandData<span class="token punctuation">[</span><span class="token string">'scheduled_time'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    <span class="token keyword">final</span> scheduledDateTime <span class="token operator">=</span> <span class="token function">DateTime</span><span class="token punctuation">(</span>
      scheduledDate<span class="token punctuation">.</span>year<span class="token punctuation">,</span>
      scheduledDate<span class="token punctuation">.</span>month<span class="token punctuation">,</span>
      scheduledDate<span class="token punctuation">.</span>day<span class="token punctuation">,</span>
      int<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>scheduledTime<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      int<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>scheduledTime<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">final</span> now <span class="token operator">=</span> DateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> allowedStartTime <span class="token operator">=</span> scheduledDateTime<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">Duration</span><span class="token punctuation">(</span>minutes<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>allowedStartTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> formattedTime <span class="token operator">=</span> <span class="token function">DateFormat</span><span class="token punctuation">(</span><span class="token string">'HH:mm'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>allowedStartTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token function">TooEarlyException</span><span class="token punctuation">(</span>
        <span class="token string">'Muito cedo! O código pode ser validado a partir das $formattedTime.'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 4. Atualizar status da demanda</span>
    <span class="token keyword">await</span> demandDoc<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> DemandStatus<span class="token punctuation">.</span>inProgress<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 5. Criar registro de serviço</span>
    <span class="token keyword">final</span> serviceId <span class="token operator">=</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'services'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'id'</span><span class="token punctuation">:</span> serviceId<span class="token punctuation">,</span>
      <span class="token string">'demand_id'</span><span class="token punctuation">:</span> demandDoc<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token string">'motorista_id'</span><span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'created_by'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">'chapa_id'</span><span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'selected_chapa_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">'service_code'</span><span class="token punctuation">:</span> serviceCode<span class="token punctuation">,</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> ServiceStatus<span class="token punctuation">.</span>inProgress<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'scheduled_date'</span><span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'scheduled_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">'scheduled_time'</span><span class="token punctuation">:</span> demandData<span class="token punctuation">[</span><span class="token string">'scheduled_time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">'started_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'created_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 6. Notificar ambas as partes</span>
    <span class="token comment">// TODO: Enviar notificações push</span>
    
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'✅ Serviço iniciado: $serviceCode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao validar código: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">rethrow</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="finalizar-serviço-e-liberar-pagamento">4.4 Finalizar Serviço e Liberar Pagamento</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/data/services/service_service.dart</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">completeService</span><span class="token punctuation">(</span>String serviceId<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Buscar dados do serviço</span>
    <span class="token keyword">final</span> serviceDoc <span class="token operator">=</span> <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'services'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> serviceData <span class="token operator">=</span> serviceDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    
    <span class="token keyword">final</span> demandId <span class="token operator">=</span> serviceData<span class="token punctuation">[</span><span class="token string">'demand_id'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    <span class="token keyword">final</span> motoristaId <span class="token operator">=</span> serviceData<span class="token punctuation">[</span><span class="token string">'motorista_id'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    <span class="token keyword">final</span> chapaId <span class="token operator">=</span> serviceData<span class="token punctuation">[</span><span class="token string">'chapa_id'</span><span class="token punctuation">]</span> <span class="token operator">as</span> String<span class="token punctuation">;</span>
    
    <span class="token comment">// 2. Buscar dados da demanda</span>
    <span class="token keyword">final</span> demandDoc <span class="token operator">=</span> <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'demands'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>demandId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> demandData <span class="token operator">=</span> demandDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> offeredValue <span class="token operator">=</span> demandData<span class="token punctuation">[</span><span class="token string">'offered_value'</span><span class="token punctuation">]</span> <span class="token operator">as</span> int<span class="token punctuation">;</span>
    
    <span class="token comment">// 3. Atualizar status do serviço</span>
    <span class="token keyword">await</span> serviceDoc<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> ServiceStatus<span class="token punctuation">.</span>completed<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'completed_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 4. Atualizar status da demanda</span>
    <span class="token keyword">await</span> demandDoc<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'status'</span><span class="token punctuation">:</span> DemandStatus<span class="token punctuation">.</span>completed<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 5. Processar pagamento</span>
    <span class="token keyword">final</span> creditsService <span class="token operator">=</span> <span class="token function">CreditsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Debitar créditos reservados do motorista</span>
    <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">deductReservedCredits</span><span class="token punctuation">(</span>
      motoristaId<span class="token punctuation">,</span>
      CreditsService<span class="token punctuation">.</span>matchAcceptedCost<span class="token punctuation">,</span>
      <span class="token string">'💸 Pagamento: Serviço concluído'</span><span class="token punctuation">,</span>
      relatedId<span class="token punctuation">:</span> serviceId<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Creditar chapa</span>
    <span class="token keyword">await</span> creditsService<span class="token punctuation">.</span><span class="token function">addCredits</span><span class="token punctuation">(</span>
      chapaId<span class="token punctuation">,</span>
      offeredValue<span class="token punctuation">,</span>
      <span class="token string">'💰 Recebido: Serviço concluído (+$offeredValue créditos)'</span><span class="token punctuation">,</span>
      relatedId<span class="token punctuation">:</span> serviceId<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 6. Notificar ambas as partes</span>
    <span class="token comment">// TODO: Enviar notificações push e WhatsApp</span>
    
    <span class="token comment">// 7. Solicitar avaliação mútua</span>
    <span class="token comment">// TODO: Trigger avaliação</span>
    
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'✅ Serviço finalizado e pagamento liberado: $serviceId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao finalizar serviço: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">rethrow</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="apis-e-integrações">5. APIS E INTEGRAÇÕES</h2>
<h3 id="whatsapp-business-api">5.1 WhatsApp Business API</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/data/services/whatsapp_service.dart</span>
<span class="token keyword">class</span> <span class="token class-name">WhatsAppService</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> String _apiUrl <span class="token operator">=</span> <span class="token string">'https://api.whatsapp.com/send'</span><span class="token punctuation">;</span>
  
  <span class="token comment">/// Enviar convite de demanda para chapa favorito</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">sendDemandInvitation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required String phoneNumber<span class="token punctuation">,</span>
    required String demandTitle<span class="token punctuation">,</span>
    required String demandLocation<span class="token punctuation">,</span>
    required DateTime scheduledDate<span class="token punctuation">,</span>
    required String scheduledTime<span class="token punctuation">,</span>
    required int offeredValue<span class="token punctuation">,</span>
    required String motoristaName<span class="token punctuation">,</span>
    required double motoristaReputation<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> message <span class="token operator">=</span> <span class="token string">'''
🚛 *Loomper - Nova Demanda!*

📍 $demandTitle
📌 Local: $demandLocation
🕐 ${DateFormat('dd/MM/yyyy').format(scheduledDate)} às $scheduledTime
💰 Pagamento: $offeredValue créditos

Você foi convidado por *$motoristaName* (Motorista ⭐ ${motoristaReputation.toStringAsFixed(1)})

Acesse o app para aceitar o convite:
https://app.loomper.com
    '''</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> <span class="token function">_sendMessage</span><span class="token punctuation">(</span>phoneNumber<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Notificar match confirmado</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">notifyMatchConfirmed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required String chapaPhone<span class="token punctuation">,</span>
    required String demandTitle<span class="token punctuation">,</span>
    required String serviceCode<span class="token punctuation">,</span>
    required DateTime scheduledDate<span class="token punctuation">,</span>
    required String scheduledTime<span class="token punctuation">,</span>
    required String location<span class="token punctuation">,</span>
    required int offeredValue<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> message <span class="token operator">=</span> <span class="token string">'''
✅ *Loomper - Match Confirmado!*

🎉 Você foi aceito para o serviço!

📍 $demandTitle
📌 Local: $location
🕐 ${DateFormat('dd/MM/yyyy').format(scheduledDate)} às $scheduledTime
💰 Pagamento: $offeredValue créditos

🔑 *Seu código de serviço:* $serviceCode
⚠️ Guarde este código. O motorista vai solicitá-lo no dia do serviço.

Até lá! 👷‍♂️
    '''</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> <span class="token function">_sendMessage</span><span class="token punctuation">(</span>chapaPhone<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Notificar cancelamento</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">notifyCancellation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required String chapaPhone<span class="token punctuation">,</span>
    required String demandTitle<span class="token punctuation">,</span>
    required String reason<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> message <span class="token operator">=</span> <span class="token string">'''
❌ *Loomper - Serviço Cancelado*

Infelizmente, o motorista cancelou o serviço:

📍 $demandTitle

Motivo: $reason

Não se preocupe, você pode se candidatar para outras demandas disponíveis no app!

https://app.loomper.com
    '''</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> <span class="token function">_sendMessage</span><span class="token punctuation">(</span>chapaPhone<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Método privado para enviar mensagem</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">_sendMessage</span><span class="token punctuation">(</span>String phoneNumber<span class="token punctuation">,</span> String message<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> encodedMessage <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">encodeComponent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> url <span class="token operator">=</span> <span class="token string">'$_apiUrl?phone=$phoneNumber&amp;text=$encodedMessage'</span><span class="token punctuation">;</span>
      
      <span class="token comment">// TODO: Integrar com WhatsApp Business API oficial</span>
      <span class="token comment">// Por enquanto, apenas registrar log</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'📱 WhatsApp enviado para $phoneNumber'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'Mensagem: $message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao enviar WhatsApp: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Não falhar se WhatsApp não enviar</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="firebase-cloud-messaging-push-notifications">5.2 Firebase Cloud Messaging (Push Notifications)</h3>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// lib/data/services/push_notification_service.dart</span>
<span class="token keyword">class</span> <span class="token class-name">PushNotificationService</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> FirebaseMessaging _messaging <span class="token operator">=</span> FirebaseMessaging<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
  <span class="token keyword">final</span> FirebaseFirestore _firestore <span class="token operator">=</span> FirebaseFirestore<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
  
  <span class="token comment">/// Inicializar serviço de notificações</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// Solicitar permissão</span>
    <span class="token keyword">final</span> settings <span class="token operator">=</span> <span class="token keyword">await</span> _messaging<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span>
      alert<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      badge<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>authorizationStatus <span class="token operator">==</span> AuthorizationStatus<span class="token punctuation">.</span>authorized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'✅ Permissão de notificação concedida'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// Obter FCM token</span>
      <span class="token keyword">final</span> token <span class="token operator">=</span> <span class="token keyword">await</span> _messaging<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">_saveFCMToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// Listener para novos tokens</span>
      _messaging<span class="token punctuation">.</span>onTokenRefresh<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>_saveFCMToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// Listener para mensagens em foreground</span>
      FirebaseMessaging<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>_handleForegroundMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// Listener para mensagens em background</span>
      FirebaseMessaging<span class="token punctuation">.</span><span class="token function">onBackgroundMessage</span><span class="token punctuation">(</span>_firebaseMessagingBackgroundHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'⚠️ Permissão de notificação negada'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Salvar FCM token no Firestore</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">_saveFCMToken</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> userId <span class="token operator">=</span> FirebaseAuth<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>currentUser<span class="token operator">?</span><span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      
      <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'fcm_tokens'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">arrayUnion</span><span class="token punctuation">(</span><span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'✅ FCM token salvo: ${token.substring(0, 20)}...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao salvar FCM token: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Handler para mensagens em foreground</span>
  <span class="token keyword">void</span> <span class="token function">_handleForegroundMessage</span><span class="token punctuation">(</span>RemoteMessage message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'📬 Notificação recebida (foreground): ${message.messageId}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Exibir notificação local</span>
    <span class="token comment">// TODO: Implementar local notification</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/// Enviar notificação para um usuário específico</span>
  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">sendToUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required String userId<span class="token punctuation">,</span>
    required String title<span class="token punctuation">,</span>
    required String body<span class="token punctuation">,</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token operator">&gt;</span><span class="token operator">?</span> data<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Buscar FCM tokens do usuário</span>
      <span class="token keyword">final</span> userDoc <span class="token operator">=</span> <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> userData <span class="token operator">=</span> userDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> fcmTokens <span class="token operator">=</span> List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>userData<span class="token operator">?</span><span class="token punctuation">[</span><span class="token string">'fcm_tokens'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fcmTokens<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'⚠️ Usuário sem FCM tokens: $userId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// TODO: Enviar notificação via Firebase Admin SDK</span>
      <span class="token comment">// (Isso seria feito no backend, não no app)</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'📤 Notificação enviada para $userId: $title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'❌ Erro ao enviar notificação: $e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Background message handler (função top-level)</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">_firebaseMessagingBackgroundHandler</span><span class="token punctuation">(</span>RemoteMessage message<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'📬 Notificação recebida (background): ${message.messageId}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2 id="troubleshooting">6. TROUBLESHOOTING</h2>
<h3 id="problemas-comuns-e-soluções">6.1 Problemas Comuns e Soluções</h3>
<h4 id="❌-erro-whatsapp-triplicado-após-cadastro"><strong>❌ Erro: WhatsApp triplicado após cadastro</strong></h4>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// PROBLEMA:</span>
<span class="token comment">// WhatsApp sendo enviado 3 vezes quando usuário se cadastra via indicação</span>

<span class="token comment">// CAUSA:</span>
<span class="token comment">// Múltiplas chamadas ao serviço de indicação sem controle de duplicidade</span>

<span class="token comment">// SOLUÇÃO:</span>
<span class="token comment">// Adicionar flag "whatsapp_sent" no documento de indicação</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">sendReferralWhatsApp</span><span class="token punctuation">(</span>String referredPhone<span class="token punctuation">,</span> String referrerName<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> referralDoc <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getReferralByPhone</span><span class="token punctuation">(</span>referredPhone<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ✅ Verificar se já foi enviado</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>referralDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token string">'whatsapp_sent'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'⚠️ WhatsApp já enviado, ignorando'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Enviar mensagem</span>
  <span class="token keyword">await</span> whatsappAPI<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>referredPhone<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ✅ Marcar como enviado</span>
  <span class="token keyword">await</span> <span class="token function">updateReferralDoc</span><span class="token punctuation">(</span>referralDoc<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'whatsapp_sent'</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">'whatsapp_sent_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="❌-erro-saldo-negativo-de-créditos"><strong>❌ Erro: Saldo negativo de créditos</strong></h4>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// PROBLEMA:</span>
<span class="token comment">// Saldo de créditos ficando negativo após múltiplas operações</span>

<span class="token comment">// CAUSA:</span>
<span class="token comment">// Transações concorrentes sem controle de atomicidade</span>

<span class="token comment">// SOLUÇÃO:</span>
<span class="token comment">// Usar Firestore Transactions para operações atômicas</span>
Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token function">deductCreditsAtomic</span><span class="token punctuation">(</span>String userId<span class="token punctuation">,</span> int amount<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> _firestore<span class="token punctuation">.</span><span class="token function">runTransaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> walletRef <span class="token operator">=</span> _firestore
        <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'wallets'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span><span class="token string">'wallet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">final</span> walletDoc <span class="token operator">=</span> <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>walletRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> currentBalance <span class="token operator">=</span> walletDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token string">'balance'</span><span class="token punctuation">]</span> <span class="token operator">as</span> int<span class="token operator">?</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ✅ Validar saldo antes de debitar</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">&lt;</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">InsufficientCreditsException</span><span class="token punctuation">(</span><span class="token string">'Saldo insuficiente'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Debitar atomicamente</span>
    transaction<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>walletRef<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'balance'</span><span class="token punctuation">:</span> currentBalance <span class="token operator">-</span> amount<span class="token punctuation">,</span>
      <span class="token string">'updated_at'</span><span class="token punctuation">:</span> FieldValue<span class="token punctuation">.</span><span class="token function">serverTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="❌-erro-código-de-serviço-inválido"><strong>❌ Erro: Código de serviço inválido</strong></h4>
<pre class=" language-dart"><code class="prism  language-dart"><span class="token comment">// PROBLEMA:</span>
<span class="token comment">// Usuário digita código incorreto repetidamente</span>

<span class="token comment">// CAUSA:</span>
<span class="token comment">// Sem feedback visual durante digitação</span>

<span class="token comment">// SOLUÇÃO:</span>
<span class="token comment">// Adicionar validação em tempo real</span>
<span class="token keyword">class</span> <span class="token class-name">ServiceCodeInput</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">TextField</span><span class="token punctuation">(</span>
      maxLength<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      keyboardType<span class="token punctuation">:</span> TextInputType<span class="token punctuation">.</span>number<span class="token punctuation">,</span>
      onChanged<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ✅ Validar formato em tempo real</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">final</span> isValid <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">r'^\d{4}$'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasMatch</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ScaffoldMessenger<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">showSnackBar</span><span class="token punctuation">(</span>
              <span class="token function">SnackBar</span><span class="token punctuation">(</span>content<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'Código deve ter 4 dígitos'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      decoration<span class="token punctuation">:</span> <span class="token function">InputDecoration</span><span class="token punctuation">(</span>
        labelText<span class="token punctuation">:</span> <span class="token string">'Código do Chapa (4 dígitos)'</span><span class="token punctuation">,</span>
        hintText<span class="token punctuation">:</span> <span class="token string">'1234'</span><span class="token punctuation">,</span>
        helperText<span class="token punctuation">:</span> <span class="token string">'Digite o código que o chapa forneceu'</span><span class="token punctuation">,</span>
        <span class="token comment">// ✅ Feedback visual</span>
        suffixIcon<span class="token punctuation">:</span> value<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span>
            <span class="token operator">?</span> <span class="token function">Icon</span><span class="token punctuation">(</span>Icons<span class="token punctuation">.</span>check_circle<span class="token punctuation">,</span> color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>green<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<p><strong>Documento Técnico - Versão 1.0</strong><br>
<strong>Gerado em:</strong> 22/01/2026<br>
<strong>Para:</strong> Desenvolvedores Profissionais<br>
<strong>Projeto:</strong> Loomper MVP</p>
<p>Este guia técnico complementa o Relatório Executivo Principal e fornece detalhes de implementação para desenvolvedores que darão continuidade ao projeto.</p>
</div>
</body>

</html>
